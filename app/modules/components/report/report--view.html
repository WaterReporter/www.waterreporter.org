<div data-ng-include="'/modules/shared/views/header--view.html'"></div>

<main class="site--content">

    <div class="throbber" data-ng-if="!page.report"></div>

    <leaflet data-ng-if="page.report" class="map" markers="page.map.markers" defaults="page.map.defaults" layers="page.map.layers" center="page.map.center" bounds="page.map.bounds"></leaflet>

    <div class="features" data-ng-if="page.report">
      <div class="container">
        <article id="report--{{ page.report.properties.id }}" class="report report--single">

          <div data-ng-include="'/modules/components/report/reportContent--view.html'"></div>

          <div class="report--comments">

            <h2>Comments</h2>

            <div id="report--comment--{{ $index }}" class="report--comments--comment"
                 data-ng-if="page.report.properties.comments.length"
                 data-ng-repeat="comment in page.comments.features | orderBy:'id':false track by $index">
              <div data-ng-if="comment.properties.body">
                <a class="report--comment--avatar" href="/profiles/{{ comment.properties.owner.id }}">
                  <img data-ng-if="comment.properties.owner.properties.email"
                       gravatar-src="'{{ comment.properties.owner.properties.email }}'"
                       gravatar-size="64" />
                </a>
                <p class="report--comment--author">
                  <a href="/profiles/{{ comment.properties.owner.id }}">
                    {{ comment.properties.owner.properties.first_name }} {{ comment.properties.owner.properties.last_name }}
                  </a>
                  <span>
                    submitted this comment
                    <span data-ng-if="page.report.timeToggle"
                          data-ng-click="page.report.timeToggle =! page.report.timeToggle"
                          am-time-ago="comment.properties.created"></span>
                    <span data-ng-if="!page.report.timeToggle"
                          data-ng-click="page.report.timeToggle =! page.report.timeToggle">
                      on {{ comment.properties.created | date:"MMM d, yyyy h:mma"}}
                    </span>
                  </span>
                </p>
                <p>
                  <span data-ng-if="!comment.edit">{{ comment.properties.body }}</span>
                </p>

                <form data-ng-if="comment.edit" class="site--report--comment--edit form"
                      role="form" id="form--reports--comment--edit"
                      name="form--reports--comment--edit"
                      data-ng-submit="page.comment.update(comment)">
                  <div class="form-group">
                    <label for="report--commentBody">Comment</label>
                    <textarea id="report--commentBody" name="report--commentBody"
                              class="form-control" data-ng-model="comment.properties.body">
                      {{ comment.properties.body }}
                    </textarea>
                  </div>
                  <button id="report--comment--submit" name="report--comment--submit" class="btn btn-success">
                    Update Comment
                  </button>
                </form>

                <a data-ng-if="$root.isAdmin || comment.properties.owner.id === $root.user.id" data-ng-click="comment.edit =! comment.edit">
                  edit
                </a>
                <a data-ng-if="$root.isAdmin || comment.properties.owner.id === $root.user.id" data-ng-click="page.comment.delete(comment.id)">
                  delete
                </a>
              </div>

              <div class="comment--action" data-ng-if="comment.properties.report_state"
                   data-ng-class="{'comment--action--reopened': comment.properties.report_state === 'open' && comment.properties.body }">
                <span class="comment--action--type" data-ng-if="comment.properties.report_state === 'open'">
                  <img src="/images/badget--CertifiedAction--Small--Reopened.svg" width="64" height="64" />
                  <p>
                    <a class="report--action--owner" href="/profiles/{{ comment.properties.owner.properties.id }}">
                      <span>Reopened By</span><br />
                      {{ comment.properties.owner.properties.first_name }} {{ comment.properties.owner.properties.last_name }}
                    </a>
                  </p>
                </span>
                <span class="comment--action--type" data-ng-if="comment.properties.report_state === 'closed'">
                  <img src="/images/badget--CertifiedAction--Small--Closed.svg" width="64" height="64" />
                  <p>
                    <a class="report--action--owner" href="/profiles/{{ comment.properties.owner.properties.id }}">
                      <span>Action Taken By</span><br />
                      {{ comment.properties.owner.properties.first_name }} {{ comment.properties.owner.properties.last_name }}
                    </a>
                  </p>
                </span>
              </div>
            </div>
          </div>

          <form data-ng-if="$root.isLoggedIn" class="site--report--comment form" role="form" id="form--reports--comment" name="form--reports--comment">
            <div class="form-group">
              <label for="report--commentBody">Comment</label>
              <textarea id="report--commentBody" name="report--commentBody" class="form-control" data-ng-model="page.comment.data.body"></textarea>
            </div>
            <button data-ng-if="$root.isAdmin && page.data.properties.state !== 'closed'" data-ng-if="page.data.properties.state !== 'closed'" class="btn btn-default" data-ng-click="page.comment.close(page.data.id)">
              Close Report
            </button>
            <button data-ng-if="$root.isAdmin && page.data.properties.state === 'closed'" data-ng-if="page.data.properties.state === 'closed'" class="btn btn-default" data-ng-click="page.comment.open(page.data.id)">
              Reopen Report
            </button>
            <button id="report--comment--submit" name="report--comment--submit" class="btn btn-success" data-ng-click="page.comment.save(page.data.id)">
              Comment
            </button>
          </form>
        </article>

        <aside class="report--metadata">
          <aside class="report--action" data-ng-if="page.report.properties.state === 'closed'">
            <img src="/images/badget--CertifiedAction--Color.svg" width="228" height="228" alt="" />

            <a class="report--action--owner" href="/profiles/{{ page.report.properties.closed_by.properties.id }}">
              <span>Action Taken By</span><br />
              {{ page.report.properties.closed_by.properties.first_name }} {{ page.report.properties.closed_by.properties.last_name }}
            </a>
          </aside>
          <header class="report--author">
            <div class="report--metadata--section">
              <p>
                <a href="/profiles/{{ page.report.properties.owner.id }}">
                  <img class="report--author--avatar" gravatar-size="32"
                       data-ng-if="page.report.properties.owner.properties.email"
                       gravatar-src="'{{ page.report.properties.owner.properties.email }}'" />
                </a>
                <a class="report--author--name" href="/profiles/{{ page.report.properties.owner.id }}">
                  {{ page.report.properties.owner.properties.first_name }} {{ page.report.properties.owner.properties.last_name }}
                </a>
                <span class="report--date">
                  submitted this report
                  <span data-ng-if="page.report.timeToggle"
                        data-ng-click="page.report.timeToggle =! page.report.timeToggle"
                        am-time-ago="page.report.properties.report_date"></span>
                  <span data-ng-if="!page.report.timeToggle"
                        data-ng-click="page.report.timeToggle =! page.report.timeToggle">
                    on {{ page.report.properties.report_date | date:"MMM d, yyyy"}}
                  </span>
                </span>
              </p>
            </div>
            <div class="report--metadata--section">
              <p data-ng-if="page.report.properties.territory">
                <small><span class="glyphicon glyphicon-map-marker"></span> {{ page.report.properties.territory.properties.huc_6_name }} Watershed</small>
              </p>
            </div>
            <div class="report--metadata--section">
              <p>
                <span class="icon icon--directions retinaicon-transport-007"></span>
                <a href="https://www.google.com/maps/dir//{{ page.report.geometry.geometries[0].coordinates[1] }},{{ page.report.geometry.geometries[0].coordinates[0] }}" target="_blank">
                  <small>Get directions to this report location</small>
                </a>
              </p>
            </div>
            <div class="report--metadata--section">
              <div class="addthis_sharing_toolbox"></div>
            </div>
            <div class="report--metadata--section"
                 data-ng-if="page.other.reports.length">
              <p class="report--metadata--sectionTitle">
                <strong>
                Other Reports by {{ page.report.properties.owner.properties.first_name }} {{ page.report.properties.owner.properties.last_name }}</strong>
              </p>
              <a href="/reports/{{ report.id }}" class="report--media"
                    data-ng-repeat="report in page.other.reports track by $index">
                  <img data-ng-if="report.properties.images[0].properties.thumbnail"
                       image-loader data="report.properties.images[0].properties.thumbnail" width="196px" />
                  <img data-ng-if="!report.properties.images[0].properties.thumbnail"
                       image-loader data="report.properties.images[0].properties.original" width="196px" />
                  <img data-ng-if="!report.properties.images[0].properties.original"
                       data-ng-src="/images/icon--MissingImage.png" width="196px" />
              </a>
            </div>
          </header>

          <button data-ng-if="$root.isAdmin" class="btn btn-danger" data-ng-click="page.delete(page.data.id)">Delete Report</button>

        </aside>

      </div>
    </div>
  </div>
</main>

<div data-ng-include="'/modules/shared/views/footer--view.html'"></div>
